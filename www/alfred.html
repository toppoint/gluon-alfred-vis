<!DOCTYPE html>
<html>
<head>
	<title>FFKI - Alfred JSON Status</title>
	<link rel="stylesheet" type="text/css" href="css/style.css" />
	<link rel="stylesheet" type="text/css" href="css/list.css" />
	<link rel="stylesheet" type="text/css" href="css/alfred.css" />
	
	<script type="text/javascript" src="lib/frameworks/jquery-1.11.0.min.js"></script>
	
	<script type="text/javascript">
	var arr = [];
	
	function inArray(needle, haystack) {
		var length = haystack.length;
		for(var i = 0; i < length; i++) {
			if(haystack[i] == needle) return true;
		}
		return false;
	}
	
	// each single node has its own json logged here:
	path_to_node_json='http://freifunk.discovibration.de/gluon-alfred-vis/www/logs/nodes/';

	// all column heads:
	var cols = [
		"hostname", 
		"uptime",
		"offline",
		"tx",
		"rx",
		"firmware",
		"model",
		"mac",
		"autoupdate",
		"contact",
		"longitude",
		"latitude",
		"autoupdate",
		"loadavg",
		"mem"
	];
	
	function fill_arr(key,val,offline){
		if(key=="additional_data"){
			// added by alfred-log.py in alfred_offline.json
			$('#headline').append(" ("+val['datetime']+")")
		}else{
			var n = [];
			n.offline=offline;
			try { n.hostname=val['hostname']															; } catch (e) {console.log('no')};
			try { n.fastd_enabled= val['software']['fastd']['enabled']?1:0								; } catch (e) {};
			try { n.address= val['network']['addresses'][0]												; } catch (e) {};
			if(val['statistics'] == null) {
				n.uptime=0;
				n.tx=0;
				n.rx=0;
				n.idletime= 0;
				n.processes_running= 0;
				n.loadavg=0;
				n.mem=0;
			} else {
				try { n.uptime=parseFloat(val['statistics']['uptime'])									; } catch (e) {};
				try { n.tx= parseFloat(val['statistics']['traffic']['tx']['bytes'])						; } catch (e) {};
				try { n.rx= parseFloat(val['statistics']['traffic']['rx']['bytes'])						; } catch (e) {};
				try { n.idletime= Math.floor(parseFloat(val['statistics']['idletime'])/3600)+'h'		; } catch (e) {};
				try { n.processes_running= val['statistics']['processes']['running']					; } catch (e) {};
				try { n.loadavg= parseFloat(val['statistics'] != null?val['statistics']['loadavg']:0)	; } catch (e) {};
				try { 
					n.mem= parseFloat(val['statistics']['memory'] != null?val['statistics']['memory']['free']:1.0) / parseFloat(val['statistics']['memory'] != null?val['statistics']['memory']['total']:0);
				} catch (e) {};
			}
			try { n.firmware=val.software?val['software']['firmware']['release']:"-"					;} catch (e) {};
			try { n.model= val['hardware']?val['hardware']['model']:"-"									; } catch (e) {};
			try { n.autoupdate= val.software?(val.software.autoupdater.enabled?val.software.autoupdater.branch:''):'-'	; } catch (e) {};
			try { n.contact= ('owner' in val?val['owner']['contact']:'')								; } catch (e) {};
			try { n.longitude= ('location' in val?val['location']['longitude']:'')						; } catch (e) {};
			try { n.latitude= ('location' in val?val['location']['latitude']:'')						; } catch (e) {};
			try { n.mac= key																			; } catch (e) {};
			arr.push(n);
		}
	}

	$(function() {
		// first add offline nodes
		var count_offline=0
		$.getJSON( 'alfred_offline.json', function(data) {
			count_offline--; // first element is "additional_data"
			$.each( data, function( key,val ) {
				fill_arr(key,val,1)
				count_offline++
			});
		});

		// add online nodes
		var count_online=0
		$.getJSON( 'alfred.json', function(data) {
			$.each( data, function( key,val ) {
				fill_arr(key,val,0)
				count_online++
			});
			
			$('#headings th').click(function() {
				var id = $(this).attr('id');
				var asc = (!$(this).attr('asc')); // switch the order, true if not set

				// set asc="asc" when sorted in ascending order
				$('#headings th').each(function() {
					$(this).removeAttr('asc');
				});
				if (asc) $(this).attr('asc', 'asc');

				sortResults(id, asc);
			});

			sortResults('hostname', true);

			$('#headline').append(" "+count_online+" online");
			$('#headline').append(" "+count_offline+" offline");
		});
	
	});

	function order(c) {
		if (/^\d$/.test(c))
			return 0;
		else if (/^[a-z]$/i.test(c))
			return c.charCodeAt(0);
		else if (c === '~')
			return -1;
		else if (c)
			return c.charCodeAt(0) + 256;
		else
			return 0;
	}

	// Based on dpkg code
	function vercomp(a, b) {
		var apos = 0, bpos = 0;
		while (apos < a.length || bpos < b.length) {
		var first_diff = 0;

		while ((apos < a.length && !/^\d$/.test(a[apos])) || (bpos < b.length && !/^\d$/.test(b[bpos]))) {
			var ac = order(a[apos]);
			var bc = order(b[bpos]);

			if (ac !== bc)
				return ac - bc;

			apos++;
			bpos++;
		}

		while (a[apos] === '0')
			apos++;
		while (b[bpos] === '0')
			bpos++;

		while (/^\d$/.test(a[apos]) && /^\d$/.test(b[bpos])) {
			if (first_diff === 0)
				first_diff = a.charCodeAt(apos) - b.charCodeAt(bpos);

				apos++;
			bpos++;
		}

		if (/^\d$/.test(a[apos]))
			return 1;

		if (/^\d$/.test(b[bpos]))
			return -1;

		if (first_diff !== 0)
			return first_diff;
		}

		return 0;
	}

	function compare(a, b) {
		try {
			a = a.toUpperCase();
			b = b.toUpperCase();
		} catch (e) {}

		if (a == b) return 0;
		else if (a > b) return 1;
		else return -1;
	}

	function sortResults(prop, asc) {
		for (var i = 0; i < arr.length; i++) {
			arr[i].pos = i;
		}

		arr = arr.sort(function(a, b) {
			var ret;

			if (prop === 'firmware' || prop === 'model')
				ret = vercomp(a[prop], b[prop]);
			else
				ret = compare(a[prop], b[prop]);

			if (ret == 0) ret = compare(a.pos, b.pos);

			if (asc) return ret;
			else return -ret;
		});
		showResults();
	}
	var all=Object;
	function showResults () {
		var html = '';
		for (var e in arr) {
			offllineclass=(arr[e].offline==1?' class="offline"':'')
			html += '<tr>'
				+'<td><a target="_blank" href="http://['+arr[e].address+']/">'+arr[e].hostname+'</a></td>'
				+'<td'+offllineclass+'>'+Math.floor(arr[e].uptime/3600)+'h</td>'
				+'<td'+offllineclass+'>'+(arr[e].offline?"offline":'')+'</td>'
				+'<td>'+Math.floor(arr[e].tx/1048576)+'</td>'
				+'<td>'+Math.floor(arr[e].rx/1048576)+'</td>'
				+'<td>'+arr[e].firmware+'</td>'
				+'<td>'+arr[e].model+'</td>'
				+'<td>'+arr[e].mac+'</td>'
				+'<td>'+arr[e].autoupdate+'</td>'
				+'<td>'+arr[e].contact+'</td>'
				+'<td>'+arr[e].longitude+'</td>'
				+'<td>'+arr[e].latitude+'</td>'
				+'<td>'+arr[e].autoupdate+'</td>'
				+'<td>'+arr[e].loadavg+'</td>'
				+'<td>'+(arr[e].mem*100).toFixed(2)+'%</td>'
				+'<td>';
			for (var p in arr[e]) {
				if (arr[e].hasOwnProperty(p) && !inArray(p,cols)) {
					if(p!="pos") html += p + ':' + arr[e][p] + '<br>';
				}
			}
			html +='<a href="'+path_to_node_json+arr[e].hostname+'" target="_blank">data</a></td>'
				+'</tr>';
		}
		$('#results').html(html);
		$('#results').append(arr.length+" Eintr&auml;ge");
		if(arr.length==0) alert("Fehler: kein Eintrag!");
	}
	
	</script>
</head>
<body>
	<header>
		<h1><a href="http://freifunk.in-kiel.de/" id="sitelink">kiel.freifunk.net</a></h1>
		<ul>
			<li><a href="http://freifunk.in-kiel.de/ffmap/graph.html">Graph</a></li>
			<li><a href="http://freifunk.in-kiel.de/ffmap/geomap.html">Karte</a></li>
			<li><a href="http://freifunk.in-kiel.de/ffmap/list.html">Liste</a></li>
		</ul>
	</header>
	<div class="container">
	<h1 id="headline">Knotenliste</h1>
	<table id="list"></table>
	</div>
	<table id="list" class="tablesorter tablesorter-default">
	<thead id="headings">
		<tr class="tablesorter-headerRow">
			<th id="hostname">hostname</th>
			<th id="uptime">uptime</th>
			<th id="offline">offline</th>
			<th id="tx">tx (mb)</th>
			<th id="rx">rx (mb)</th>
			<th id="firmware">firmware</th>
			<th id="model">model</th>
			<th id="mac">mac</th>
			<th id="autoupdate">autoupdate</th>
			<th id="contact">contact</th>
			<th id="longitude">long</th>
			<th id="latitude">lat</th>
			<th id="autoupdate">autoupdate</th>
			<th id="loadavg">loadavg</th>
			<th id="mem">mem free</th>
			<th id="more">more</th>
		</tr>
	</thead>
	<tbody id="results">
		<tr><td colspan="0" style="text-align:center;">this page needs JavaScript to work. Data will be loaded...</td></tr>
	</tbody>
	</table>
</body>
</html>
